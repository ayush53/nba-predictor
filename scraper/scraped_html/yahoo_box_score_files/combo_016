YUI.add("af-comet",function(e,t){"use strict";function B(e){if(!e)return N;var t,n;return g.test(e)?(t=parseInt(e,10),n="D"+t,n.length<14&&(t*=1e3),t):(t=e.match(y),t?(t=Array.prototype.slice.call(t),t.shift(),t[1]=parseInt(t[1],10)-1,(new Date(t[0],t[1],t[2],t[3],t[4],t[5])).getTime()):N)}function j(e){var t,n=e.length,r=0;for(t=0;t<n;t++)r+=e[t];return Math.round(r/n)}function F(e){var t=Math.floor(e.length/2);return e.length%2?e[t]:Math.round((e[t-1]+e[t])/2)}function I(e){var r,i=a?a.trackLatency:u.trackLatency;if(!i||c||!h)return;e=parseInt(e,10);if(typeof e!="number")return;l.push(e),r=parseInt(a&&a.latencySampleSize,10)||u.latencySampleSize,l.length>=r&&(c=!0,l.sort(function(e,t){return e-t}),h.info(t,{code:"onepushLatency",clientId:n[O]&&n[O].getClientId(),sampleSize:l.length,min:l[0],max:l[l.length-1],median:F(l),mean:j(l)}),l=[])}function q(e){return a.publicCometHost===a.privateCometHost?O:e.indexOf("*")>0?A:O}function R(t,n,i){var s=r[t],o=e.merge({clientId:s.clientId},i);d.each(s.proxies,function(t){t.fire(n,o)})}function U(e,t){var n=r[t];n.tries=n.tries?n.tries+1:1,n.tries<=a.subscribeMaxTries&&e.subscribe(t)}function z(e){var t,s,o,u=[];for(t=0,s=i.length;t<s;t++)o=i[t],q(o)===e?(r[o].state=C,U(n[e],o)):u.push(o);i=u}function W(e){var t=n[e];t.addListener(T,function(n){n.successful&&z(e)}),t.addListener(E,function(n){var i=n.subscription,s=r[i],o;if(!n.successful){s&&(s.state=L),o=b.test(n.error)||w.test(n.error);if(!o||s.tries>=a.subscribeMaxTries){s.tries=0,R(i,H,{code:"subscribe",message:n.error||"",clientId:n.clientId});return}U(t,i);return}s||(s=r[i]={state:N,proxies:{}}),s.state=k,s.clientId=n.clientId,R(i,_,{clientId:n.clientId,tries:s.tries}),t.addListener(i,function(t){if(t){var n,r,s=f.length;for(r=0;r<s;r++){n=f[r].parse(t);if(n){R(i,P,{clientId:t.clientId,messages:n});return}}}})}),t.addListener(S,function(t){var n=t.subscription,i=r[n];i&&(i.tries=0);if(!t.successful){R(n,H,{code:"unsubscribe",message:t.error||"",clientId:t.clientId});return}i&&(i.state=L,R(n,D,{clientId:t.clientId}))})}function X(r){if(n[r])return;if(a.shutdown){h&&p.urlParseBoolean(a.trackShutdown)&&h.info(t,{code:"shutdown"},m);return}if(!v(e.initComet)){h&&h.error(t,{},{code:"nocomet"},m);return}var i=n[r]=e.initComet(a[r+"CometHost"]);i.config(["subscribe","jsonpTimeout"],a.subscribeTimeout),W(r),i.getClientState()===M&&z(r),h&&p.urlParseBoolean(a.trackInitComet)&&h.info(t,{code:r+"Comet"},m)}function V(t){var s=r[t],o=q(t),u=n[o];u&&s.state!==k&&s.state!==C&&(u.getClientState()===M?(s.state=C,U(u,t)):e.Array.indexOf(i,t)<0&&i.push(t))}function $(e){this.id=++s,this.channel=e}var n={},r={},i=[],s=0,o="http://comet.yahoo.com/comet",u={publicCometHost:o,privateCometHost:o,shutdown:!1,subscribeMaxTries:1,subscribeTimeout:5e3,trackInitComet:!1,trackShutdown:!1,trackLatency:!0,latencySampleSize:50},a,f,l=[],c=!1,h=e.Af.Beacon,p=e.Af.Utils,d=e.Object,v=e.Lang.isFunction,m={once:!0},g=/^\d+$/,y=/^(\d+)\-(\d+)\-(\d+) (\d+):(\d+):(\d+)$/,b=/^408:\d+:jsonp timeout$/,w=/^500::jsonp failed$/,E="/meta/subscribe",S="/meta/unsubscribe",x="/meta/unsuccessful",T="/meta/handshake",N=null,C="opening",k="open",L="closed",A="private",O="public",M="connected",_="open",D="close",P="message",H="error";(function(){function n(e){var t=window.location.protocol;return e&&(t.indexOf("https")===0?e=e.replace(/http:/,"https:"):e=e.replace(/https:/,"http:")),e}var r=e.Af.Config,i=r.get("context")||{},s=i.onepush_publicCometHost,o=i.onepush_privateCometHost;a=e.merge(u,r.get("onepush"),r.get("comet")),s&&(a.publicCometHost=s),o&&(a.privateCometHost=o),a.publicCometHost=n(a.publicCometHost),a.privateCometHost=n(a.privateCometHost)})(),f=[{parse:function(t){var n,r;if(!t||t.channel.indexOf("/sports/games/")<0)return N;try{n=e.JSON.parse(t.data)}catch(i){return N}return!n||t.channel!==n.chn?N:(r=[],e.Array.each(n.updates,function(t){var n=B(t.lastUpdatedTs),i=B(t.lastUpdated),s=(new Date).getTime(),o={};t.update&&t.update.length&&(e.Array.each(t.update,function(e){e._op==="up"&&p.objectSetValue(o,e.key,e.value)}),r.push({data:o,seq:t.seq,time:t.time,lastUpdated:i,lastUpdatedTs:n}));try{n?I(s-n):i&&I(s-i)}catch(u){}}),r)}},{parse:function(t){return!t||!t.data?N:e.Lang.isArray(t.data)?t:[t]}}],$.prototype={close:function(){var e=this,t=e.channel,i=r[t];e.fire(D),e.detachAll(),i&&(delete i.proxies[e.id],d.size(i.proxies)===0&&(i.state===k||i.state===C)&&n[q(t)].unsubscribe(t))}},e.augment($,e.EventTarget,!0,N,{emitFacade:!0}),e.namespace("Af").CometChannelProxy=$,e.namespace("Af").Comet={open:function(e){if(!e)return N;var t;X(q(e)),r[e]=r[e]||{state:N,proxies:{}},t=new $(e),r[e].proxies[t.id]=t;switch(r[e].state){case k:window.setTimeout(function(){t.fire(_,{clientId:r[e].clientId})},0);break;case C:break;default:V(e)}return t},parseLastUpdated:B}},"@VERSION@",{requires:["af-beacon","af-config","comet","event-custom-base","json-parse"]});
;YUI.add("af-pipe",function(e,t){"use strict";function L(){this._items=[]}function A(){this._item=null}function O(r){var i=this;i._host=r.host,i._cfg=e.merge(d,n.get("pipe")),e.stamp(i),i._channel=r.pipe&&r.pipe.channel||i._host&&(i._host.pipeChannel||i._host.get("pipeChannel")),i._meta={channel:i._channel},i._publishEvents(),e.Af.Beacon&&i.on([N,T],function(n){e.Af.Beacon.error(t,i._meta,e.merge({code:n.type},n.pipe))})}var n=e.Af.Config,r=e.Lang,i=e.Object,s=e.Array,o=e.Af.Utils,u=n.isFeatureOn("pipedebug"),a=r.isFunction,f=r.isNumber,l=r.isObject,c=r.isValue,h="lastUpdated",p="noseq",d={msg_maxidle:3e5,msg_throttle:2e3,seq_algo:h},v={},m="host-missing-seq",g="invalid-seq",y="open-failed",b="close-failed",w="ts-outoforder",E=null,S=!0,x="close",T="error",N="idle",C="open",k="message";v[p]=L,L.prototype={empty:function(){return!this._items.length},pop:function(e,t){var n=this._items;return this._items=[],t&&t(E,n)},push:function(e,t){return this._items.push(e),t&&t(E)}},v[h]=A,A.prototype={empty:function(){return!this._item},pop:function(e,t){var n=this,r=n._item;return!r||!e?t&&t(E,E):(n._item=E,e.lastUpdatedTs&&r.lastUpdatedTs&&r.lastUpdatedTs>=e.lastUpdatedTs?t&&t(E,[r]):e.lastUpdated&&r.lastUpdated&&r.lastUpdated>=e.lastUpdated?t&&t(E,[r]):t&&t(E,E))},push:function(e,t){var n,r,i=this;return e?i._item?(e.lastUpdatedTs&&i._item.lastUpdatedTs?(n=i._item.lastUpdatedTs,r=e.lastUpdatedTs):e.lastUpdated&&i._item.lastUpdated&&(n=i._item.lastUpdated,r=e.lastUpdated),r?n>r?t&&t({code:w,message:n+">"+r}):(n===r?i._item=e:n<r&&(i._item=o.objectMerge(i._item,e)),t&&t(E)):t&&t({code:g,message:"invalid msg. algo=lastUpdated"})):(i._item=e,t&&t(E)):t&&t(E)}},O.NS="pipe",O.prototype={open:function(t){t=e.merge({delay:0},t);var n=Math.max(0,t.delay-3e4),r=e.Lang.now(),i,s=this;n>0?(i=r+n,s._delayTimer&&i<s._delayTimer.when&&(s._delayTimer.cancel(),s._delayTimer=E),s._delayTimer||(s._delayTimer=e.later(n,s,s._open,[t]),s._delayTimer.when=i)):s._open(t)},close:function(){var e=this;e._delayTimer&&(e._delayTimer.cancel(),e._delayTimer=E),e._idleTimer&&(e._idleTimer.cancel(),e._idleTimer=E),e._io&&(e._io.close(),e._io=E)},config:function(t){this._cfg=e.merge(d,n.get("pipe"),t)},destroy:function(){this.close()},_getSeqId:function(){var t=this,n=t._host,r,i=e.Af.Comet.parseLastUpdated;if(t._cfg.seq_algo===h){r={lastUpdatedTs:i(t.lastUpdatedTs||n&&(n.lastUpdatedTs||n.get("lastUpdatedTs"))),lastUpdated:i(t.lastUpdated||n&&(n.lastUpdated||n.get("lastUpdated")))};if(f(r.lastUpdatedTs)||f(r.lastUpdated))return r}return E},_setIdleTimer:function(){var t=this;t._idleTimer&&t._idleTimer.cancel(),t._idleTimer=e.later(t._cfg.msg_maxidle,E,function(){t._fireEvent(N,{idleTime:t._cfg.msg_maxidle})})},_open:function(t){var n=this,r=n._cfg.seq_algo;if(r!==p&&n._getSeqId()===E){n._fireEvent(T,{code:m,message:"algo="+r});return}n._delayTimer&&(n._delayTimer.cancel(),n._delayTimer=E),n._io||(n._io=e.Af.Comet.open(n._channel),n._io.on("open",function(t){n._meta.clientId=t.clientId,n._fireEvent(C)}),n._io.on("close",function(t){n._msgQ=E,n._fireEvent(x)}),n._io.on("message",n._onMessage,n),n._io.on("error",n._onError,n))},_onError:function(e){e.code==="subscribe"?this._fireEvent(T,{code:y,message:e.message,clientId:e.clientId}):e.code==="unsubscribe"&&this._fireEvent(T,{code:b,message:e.message,clientId:e.clientId})},_onMessage:function(e){var t=this,n;t._msgQ||(n=v[t._cfg.seq_algo]||v[p],t._msgQ=new n),t.throttled_pop=t.throttled_pop||o.throttle(function(){if(!t._msgQ||t._msgQ.empty())return;t._msgQ.pop(t._getSeqId(),function(e,n){if(e)return;if(!n||!n.length)return;var r={},i,u;s.each(n,function(e){r=o.objectMerge(r,e.data),i=e.lastUpdatedTs,u=e.lastUpdated}),c(i)&&(r.lastUpdatedTs=i),c(u)&&(r.lastUpdated=u),t._fireEvent(k,{data:r})})},t._cfg.msg_throttle),s.each(e.messages,function(n){if(!n)return;t._setIdleTimer(),t._msgQ&&t._msgQ.push({lastUpdatedTs:n.lastUpdatedTs,lastUpdated:n.lastUpdated,data:n.data},function(e){e?t._fireEvent(T,e):t.throttled_pop()})})},_fireEvent:function(e,t){this.fire(e,{pipe:t||{}}),u&&console&&console.log&&console.log("pipe event:",this._meta,e,t||"")},_publishEvents:function(){var e=this;e.publish(x,{emitFacade:S}),e.publish(T,{defaultFn:e._defaultErrFn,emitFacade:S}),e.publish(N,{defaultFn:e._defaultIdleFn,emitFacade:S}),e.publish(C,{emitFacade:S}),e.publish(k,{defaultFn:e._defaultMessageFn,emitFacade:S})},_defaultErrFn:function(e){},_defaultIdleFn:function(e){this.close()},_defaultMessageFn:function(t){var n=this,r={},i=n._host,s=t.pipe.data;if(!s)return;i&&a(i.setAttrs)?(e.Object.each(s,function(e,t){var n=i.get(t);l(n)?r[t]=o.objectMerge(n,e):r[t]=e}),i.setAttrs(r)):i||(s.lastUpdatedTs&&(n.lastUpdatedTs=s.lastUpdatedTs),s.lastUpdated&&(n.lastUpdated=s.lastUpdated))}},e.augment(O,e.EventTarget,S,null,{emitFacade:S}),e.namespace("Af").Pipe=O},"@VERSION@",{requires:["af-beacon","af-comet","af-config","af-utils","event-custom-base"]});
;